image: gitlab-runner/owl

before_script:
  - chmod +x gradlew

stages:
  - build
  - test
  - deploy
  - bench

variables:
  GRADLE: ./.gradle
  GRADLE_HOME: $GRADLE
  GRADLE_USER_HOME: $GRADLE


# Building

Build:
  stage:
    build
  cache:
    paths:
    - $GRADLE
  script:
    - ./gradlew --no-daemon -Pfull check buildBin
    - scripts/check_binaries.sh
  artifacts:
    paths:
    - build/tmp/
    - build/reports/
    when: on_failure
    expire_in: 1 week
  artifacts:
    paths:
    - build/bin/
    - build/lib/
    when: on_success
    expire_in: 2 hours


# Artifact

Assemble:
  stage:
    deploy
  cache:
    paths:
    - $GRADLE
  script:
    - ./gradlew --no-daemon distZip
  dependencies:
  - Build
  artifacts:
    paths:
    - build/distibutions/
    expire_in: 1 hour # should be longer


# Templates

.ltlcross: &ltlcross_template
  script:
    - python3 scripts/util.py test $TEST_NAME
  artifacts:
    paths:
    - build/results/
    when: always
    expire_in: 1 week
  dependencies:
  - Build

.benchmark: &benchmark_template
  stage: bench
  script:
    - python3 scripts/util.py bench $BENCH_NAME | tee benchmark.txt
  artifacts:
    paths:
    - benchmark.txt
    when: always
    expire_in: 1 week
  when: manual
  dependencies:
  - Build


# Tests

## LTL to Automaton

LTL2LDBA:
  stage: test
  variables:
    TEST_NAME: "ltl2ldba-small;ltl2ldba"
  <<: *ltlcross_template

LTL2LDGBA:
  stage: test
  variables:
    TEST_NAME: "ltl2ldgba-small;ltl2ldgba"
  <<: *ltlcross_template

LTL2DPA:
  stage: test
  variables:
    TEST_NAME: "ltl2dpa-small;ltl2dpa"
  <<: *ltlcross_template

FGX2DPA:
  stage: test
  variables:
    TEST_NAME: "fgx2dpa"
  <<: *ltlcross_template

LTL2DRA:
  stage: test
  variables:
    TEST_NAME: "ltl2dra-medium"
  <<: *ltlcross_template

LTL2DA:
  stage: test
  variables:
    TEST_NAME: "ltl2da"
  <<: *ltlcross_template

DELAG:
  stage: test
  variables:
    TEST_NAME: "delag-strict;delag"
  <<: *ltlcross_template

Rabinizer:
  stage: test
  variables:
    TEST_NAME: "rabinizer"
  <<: *ltlcross_template

NBA2LDBA:
  stage: test
  variables:
    TEST_NAME: "nba2ldba"
  <<: *ltlcross_template

NBA2DPA:
  stage: test
  variables:
    TEST_NAME: "nba2dpa"
  <<: *ltlcross_template

NBA2DRA:
  stage: test
  variables:
    TEST_NAME: "safra"
  <<: *ltlcross_template

## Conversions

DPA Conversion:
  stage: test
  variables:
    TEST_NAME: "ltl2dpa-convert"
  <<: *ltlcross_template

## Benchmarks

LTL2LDBA Benchmark:
  variables:
    BENCH_NAME: "ltl2ldba"
  <<: *benchmark_template

DELAG Benchmark:
  variables:
    BENCH_NAME: "delag"
  <<: *benchmark_template

LTL2DPA Benchmark:
  variables:
    BENCH_NAME: "ltl2dpa"
  <<: *benchmark_template

LTL2DA Benchmark:
  variables:
    BENCH_NAME: "ltl2da"
  <<: *benchmark_template
