image: gitlab-runner/owl

before_script:
  - chmod +x gradlew

stages:
  - build
  - test
  - test-optimizations
  - test-parallel-translation

build:
  stage:
    build
  script:
    - ./gradlew --no-daemon build
  artifacts:
    paths:
    - build/reports/
    when: on_failure
    expire_in: 1 week

.ltlcross: &ltlcross_template
  script:
    - JAVA_OPTS="-enableassertions"
    - SPOT_TOOL="{spot} ltl2tgba -H -f %f >%O"
    - ./gradlew --no-daemon distTar
    - tar xvf build/distributions/owl-*.tar -C build --strip-components=1
    - ltlcross --determinize --stop-on-error --grind=debug.ltl --timeout=300 -F "formulas/base.ltl" "$SPOT_TOOL" "$LTL_TOOL"
    - ltlcross --determinize --stop-on-error --grind=debug.ltl --timeout=300 -F "formulas/regressions.ltl" "$SPOT_TOOL" "$LTL_TOOL"
    - ltlcross --stop-on-error --grind=debug.ltl --timeout=300 -F "formulas/check.ltl" "$SPOT_TOOL" "$LTL_TOOL"
    - randltl --seed=12345 -n 19 a b c d e f --tree-size=5..25 | ltlfilt --nnf | ltlcross --stop-on-error --grind=debug.ltl --timeout=300 "$SPOT_TOOL" "$LTL_TOOL"
  artifacts:
    paths:
    - debug.ltl
    when: on_failure
    expire_in: 1 week

# LTL to LDBA translations

test:ltl2ldba Büchi:
  stage: test-optimizations
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --Buchi %f >%O"
  <<: *ltlcross_template

test:ltl2ldba Büchi Non-Det:
  stage: test-optimizations
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --Buchi --nondeterministic-initial-component %f >%O"
  <<: *ltlcross_template

test:ltl2ldba Büchi Vanilla:
  stage: test
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --Buchi --optimisations=REMOVE_EPSILON_TRANSITIONS %f >%O"
  <<: *ltlcross_template

test:ltl2ldba Büchi Guess-F:
  stage: test-optimizations
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --Buchi --guess-F %f >%O"
  <<: *ltlcross_template

test:ltl2ldba Büchi Guess-F Vanilla:
  stage: test
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --Buchi --guess-F --optimisations=REMOVE_EPSILON_TRANSITIONS %f >%O"
  <<: *ltlcross_template

test:ltl2ldba generalised-Büchi:
  stage: test-optimizations
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --generalised-Buchi %f >%O"
  <<: *ltlcross_template

test:ltl2ldba generalised-Büchi Non-Det:
  stage: test-optimizations
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --generalised-Buchi --nondeterministic-initial-component %f >%O"
  <<: *ltlcross_template

test:ltl2ldba generalised-Büchi Vanilla:
  stage: test
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --generalised-Buchi --optimisations=REMOVE_EPSILON_TRANSITIONS %f >%O"
  <<: *ltlcross_template

test:ltl2ldba generalised-Büchi Guess-F:
  stage: test-optimizations
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --generalised-Buchi --guess-F %f >%O"
  <<: *ltlcross_template

test:ltl2ldba generalised-Büchi Guess-F Vanilla:
  stage: test
  variables:
    LTL_TOOL: "{ltl2ldba} build/bin/ltl2ldba --generalised-Buchi --guess-F --optimisations=REMOVE_EPSILON_TRANSITIONS %f >%O"
  <<: *ltlcross_template

# NBA to LDBA translations

test:nba2ldba Vanilla:
  stage: test
  variables:
    LTL_TOOL: "{nba2ldba} ltl2tgba --ba -H -f %f | build/bin/nba2ldba --optimisations=REMOVE_EPSILON_TRANSITIONS >%O"
  script:
    - JAVA_OPTS="-enableassertions"
    - SPOT_TOOL="{spot} ltl2tgba -H -f %f >%O"
    - ./gradlew --no-daemon distTar
    - tar xvf build/distributions/owl-*.tar -C build --strip-components=1
    - ltlcross --determinize --stop-on-error --grind=debug.ltl --timeout=300 -F "formulas/base.ltl" "$SPOT_TOOL" "$LTL_TOOL"
  artifacts:
    paths:
    - debug.ltl
    when: on_failure
    expire_in: 1 week

# LTL to DPA translations

test:ltl2dpa:
  stage: test-optimizations
  variables:
    LTL_TOOL: "{ltl2dpa} build/bin/ltl2dpa %f >%O"
  <<: *ltlcross_template

# Copy & Modify - Spot cannot handle parity automata without optimisation.
test:ltl2dpa Vanilla:
  stage: test
  variables:
    LTL_TOOL: "{ltl2dpa} build/bin/ltl2dpa --optimisations=none %f >%O"
  script:
    - JAVA_OPTS="-enableassertions"
    - SPOT_TOOL="{spot} ltl2tgba -H -f %f >%O"
    - ./gradlew --no-daemon distTar
    - tar xvf build/distributions/owl-*.tar -C build --strip-components=1
    - ltlcross --stop-on-error --grind=debug.ltl --timeout=300 -F "formulas/base.ltl" "$SPOT_TOOL" "$LTL_TOOL"
    - ltlcross --stop-on-error --grind=debug.ltl --timeout=300 -F "formulas/regressions.ltl" "$SPOT_TOOL" "$LTL_TOOL"
  artifacts:
    paths:
    - debug.ltl
    when: on_failure
    expire_in: 1 week

test-parallel:ltl2dpa Parallel:
  stage: test-parallel-translation
  variables:
    LTL_TOOL: "{ltl2dpa} build/bin/ltl2dpa --parallel %f >%O"
  <<: *ltlcross_template

# LTL to D*A translations

test-parallel:ltl2det-parallel:
  stage: test-parallel-translation
  variables:
    LTL_TOOL: "{ltl2da} build/bin/ltl2da --parallel %f >%O"
  <<: *ltlcross_template

# FGX to DGA translations

test:fgx2dga Strict:
  stage: test
  variables:
    LTL_TOOL: "{fgx2dga} build/bin/fgx2dga --strict --optimisations=none %f >%O"
    LTL_TOOL_FALLBACK: "{fgx2dga} build/bin/fgx2dga --optimisations=none %f >%O"
  script: 
    - JAVA_OPTS="-enableassertions"
    - SPOT_TOOL="{spot} ltl2tgba -H -f %f >%O"
    - ./gradlew --no-daemon distTar
    - tar xvf build/distributions/owl-*.tar -C build --strip-components=1
    - ltlcross --stop-on-error --grind=debug.ltl --timeout=300 -F "formulas/base.ltl" "$SPOT_TOOL" "$LTL_TOOL" "$LTL_TOOL_FALLBACK"
    - ltlcross --stop-on-error --grind=debug.ltl --timeout=300 -F "formulas/fgx.ltl" "$SPOT_TOOL" "$LTL_TOOL" "$LTL_TOOL_FALLBACK"
  artifacts:
    paths:
    - debug.ltl
    when: on_failure
    expire_in: 1 week

test:fgx2dga Vanilla:
  stage: test
  variables:
    LTL_TOOL: "{fgx2dga} build/bin/fgx2dga --optimisations=none %f >%O"
  <<: *ltlcross_template

test:fgx2dga:
  stage: test-optimizations
  variables:
    LTL_TOOL: "{fgx2dga} build/bin/fgx2dga %f >%O"
  <<: *ltlcross_template

